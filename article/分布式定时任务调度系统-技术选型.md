# 分布式定时任务调度系统-技术选型

## 1.我们需要解决的问题

问题1：仓库内模型，每个模型可以灵活配置，每个模型执行完后执行下一个模型，流程式串联执行；

问题2：目前数据库中定时任务执行的函数，不清楚是否执行成功，没有执行记录，难以问题追踪；

问题3：基于应用场景不同，支持做业分片并行和依赖做业串行；

问题4：统一管理、统一监控，防止进程假死，运行状态不清楚；

问题5：模型多了，机器资源的合理利用很关键，同时要支持容错、容灾、高可用。


## 2.技术选型对比

* 分布式定时任务：把分散的，可靠性差的计划任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。目前常见开源方案如下：


|   序号   |  技术  | 功能 |  优势  |  缺点  |
|  :----:  | :----:  | :----:  | :----:  | :----:  |
| 1  | quartz | 通过在数据库中配置定时器信息， 以数据库悲观锁的方式达到同一个任务始终只有一个节点在运行；依赖：mysql | 保证节点高可用 （HA）， 如果某一个几点挂了， 其他节点可以顶上文档完善、简单易学 | 同一个任务只能有一个节点运行，其他节点将不执行任务，性能低，资源浪费；当碰到大量短任务时，各个节点频繁的竞争数据库锁，节点越多这种情况越严重，性能会很低下；quartz 的分布式仅解决了集群高可用的问题，并没有解决任务分片的问题，不能实现水平扩展；不适用于分布式场景,没有管理界面 |
| 2  | xxl-job | 轻量级分布式任务调度框架 分调度中心和执行器， 调度中心在启动初始化的时候，会默认生成执行器的RPC代理对象（http协议调用）， 执行器项目启动之后， 调度中心在触发定时器之后通过jobHandle 来调用执行器项目里面的代码，核心功能与elastic-job差不多 依赖：mysql ,jdk1.7+ , maven3.0+ 集群部署 | 支持任务分片 弹性扩容，分片广播，故障转移，Rolling实时日志，GLUE（支持在线编辑代码，免发布）,任务进度监控，任务依赖，数据加密，邮件报警，运行报表，国际化 有管理界面、开发迅速、学习简单、轻量级、易扩展 | 调度中心通过获取 DB锁来保证集群中执行任务的唯一性， 如果短任务很多，随着调度中心集群数量增加，那么数据库的锁竞争会比较厉害，性能不好 不支持依赖做业串行执行 |        
| 3  | Elastic-Job（推荐）  | 当当网基于quartz二次开发，由两个相对独立的子项目Elastic-Job-Lite和Elastic-Job-Cloud组成 。Elastic-Job-Lite定位为轻量级无中心化解决方案，使用jar包的形式提供分布式任务的协调服务；Elastic-Job-Cloud使用Mesos + Docker(TBD)的解决方案，额外提供资源治理、应用分发以及进程隔离等服务；依赖：jdk1.7+, zookeeper3.4.6+ ,maven3.0.4+ ,mesos | 基于quartz 定时任务框架，具备quartz的大部分功能； 使用zookeeper做协调，调度中心，更加轻量级； 支持任务的分片； 支持弹性扩容，可以水平扩展 失效转移，容错处理； 运维界面，可以管理作业和注册中心；文档完善、有管理界面 | elastic-job-lite  不支持动态添加作业；需要引入zookeeper , mesos, 增加系统复杂度, 学习成本较高 |
| 4  | Saturn（推荐）  | 唯品会基于当当elastic-job 1.0版本来开发，取代传统的Linux Cron/Spring Batch Job的方式，作到统一配置，统一监控，任务高可用以及分片并发处理。主要是去中心化，高可用，可分片，动态扩容，有认证和受权功能。  | 支持多种语言做业，支持秒级调度支持做业分片并行执行支持依赖做业串行执行支持做业高可用和智能负载均衡支持异常检测和自动失败转移 支持异地容灾  支持多个集群部署  支持跨机房区域部署  支持弹性动态扩容  支持优先级和权重设置  支持多个时间段暂停执行控制  支持超时告警和超时强杀控制  支持异常、超时和没法高可用做业监控告警和简易的故障排除  | 技术文档较少  |
| 5  | Opencron（不推荐）  | 一个功能完善真正通用的linux定时任务调度定系统,满足多种场景下各种复杂的定时任务调度,同时集成了linux实时监控,webssh,提供一个方便管理定时任务的平台 依赖：jdk1.7+ , Tomcat8.0+ | 时间规则支持quartz和crontab ，kill任务， 现场执行，查询任务运行状态  难易程度一般，有管理界面  | 主要功能是着重于任务的修改和查询上。 不能动态的添加任务以及任务分片。  文档少  不能集群部署  不适用于分布式场景  |
| 6  | Antares（不推荐）  | 基于 Quartz 的分布式调度 Linux定时任务调度定系统,满足多种场景下各种复杂的定时任务调度,同时集成了linux实时监控,webssh,提供一个方便管理定时任务的平台 依赖：jdk 1.7+ , redis , zookeeper  | 一个任务仅会被服务器集群中的某个节点调度，调度机制基于成熟的 quartz  并行执行，用户可通过对任务预分片，有效提升任务执行效率  失效转移  弹性扩容  有管理界面 | 不能动态的添加任务，仅能在控制台对任务进行触发，暂停，删除等操作文档不多  |

![image](https://user-images.githubusercontent.com/64882640/155666622-21c420d6-0699-40ae-b817-d9302ce364ac.png)


## 3.我们的解决方案

* 推荐解决方案：Saturn

![image](https://user-images.githubusercontent.com/64882640/155666704-26cad1f0-8574-4f75-bcbe-d1024e3fd276.png)

* 1.基础架构


 ![image](https://user-images.githubusercontent.com/64882640/155666781-87e9481b-7428-48e6-82a5-ffc2919284c6.png)
 
 ![image](https://user-images.githubusercontent.com/64882640/155666802-d4117313-4a7b-4990-ba17-854750aeff75.png)

* 2.作业状态变迁


![image](https://user-images.githubusercontent.com/64882640/155666858-c1b23272-0dc1-43cd-a362-7f2cbed7e3e3.png)

* 3.系统逻辑架构


![image](https://user-images.githubusercontent.com/64882640/155666909-1ebd85bb-6230-48ec-bb5a-f86dbd238621.png)

* 4.部署模拟（跨机房）


![image](https://user-images.githubusercontent.com/64882640/155666968-ecf12497-4e5c-4bac-9736-e0bad6628aee.png)

* 5.容器化管理流程


![image](https://user-images.githubusercontent.com/64882640/155667032-5f320aae-e5e3-429e-bed6-6345d960d618.png)



